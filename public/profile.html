<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - TerraVista</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=cake" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      border-radius: 10px;
      padding: 20px;
      border: none;
    }
    .header {
      width: 100%;
      background-color: #000;
      padding: 10px 30px;
      position: fixed;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
    }
    .header img {
      height: 80px;
      cursor: pointer;
    }
    .signout-link {
      font-size: 14px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
    }
    .signout-link:hover {
      text-decoration: underline;
    }
    .profile-container {
      margin-top: 120px;
      width: 360px;
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      color: #333;
      text-align: center;
    }
    .profile-photo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #ddd;
      margin: 0 auto 15px;
      background-image: url('Photo/profile-photo.jpg');
      background-size: cover;
      background-position: center;
    }
    .profile-name {
      font-size: 22px;
      margin-top: 10px;
      font-weight: 600;
    }
    .profile-email {
      color: #888;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .edit-profile-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 14px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
    }
    .edit-profile-btn:hover {
      background-color: #0056b3;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      padding: 10px 0;
      background: #f7f7f7;
      border-radius: 5px;
    }
    .stats div {
      text-align: center;
      font-size: 14px;
      color: #333;
    }
    .achievements, .intro {
      margin-top: 30px;
      width: 90%;
      max-width: 800px;
      background: #fff;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    .achievements h3, .intro h3 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }
    .achievement-item, .intro-item {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      padding-left: 16px;
    }
    .trips-container{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: 30px;
      width: 90%;
      max-width: 800px;
      background: #fff;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); 
    }
    .trips-section {
      margin-top: 2rem;
      width: 100%;
      max-width: 800px;
      background: #f1f1f1;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }
    .trips-section h3 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }
    .trip-actions {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }
    .trip-actions a {
      display: inline-block;
      padding: 10px 20px;
      font-size: 14px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: background 0.3s;
    }
    .trip-actions a:hover {
      background-color: #0056b3;
    }
    .travel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 2rem;
    }
    .travel-card {
      background: #e5e5e5;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
      position: relative;
    }
    .travel-card:hover {
      transform: scale(1.0175);
    }
    .travel-card img {
      width: 100%;
      height: 500px;
      object-fit: cover;
    }
    .travel-card-content {
      padding: 15px;
    }
    .travel-card-content h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    .travel-card-content p {
      font-size: 14px;
      color: #777;
      margin-bottom: 10px;
    }
    .photo-section {
      margin-top: 10px;
    }
    .photo-section img {
      width: 100%;
      max-width: 80px;
      height: 80px;
      object-fit: cover;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s, box-shadow 0.3s ease-out;
    }
    .photo-section img:hover{
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }
    .form-group {
      margin: 10px 0;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin: 5px 0;
      border-radius: 5px;
    }
    .form-group button {
      background: #007bff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .form-group button:hover {
      background: #0056b3;
    }
    .photo-comment-section {
      margin-top: 10px;
      text-align: left;
    }
    .photo-comment {
      margin: 5px 0;
      padding: 10px;
      background: #f7f7f7;
      border-radius: 5px;
    }
    .row{
      display: flex;
      width: 100%;
      justify-content: space-between;
      align-items: center;
    }
    .trip-detail-btn{
      padding: 10px 20px;
      font-size: 14px;
      color: #007bff;
      background-color: rgba(0, 0, 0, 0);
      border: 1px solid #007bff;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease-out;
    }
    .trip-detail-btn:hover{
      background-color: #007bff;
      color: #fff;
    }
    .material-symbols-outlined{

    }
    .trip-label{
      font-weight: 600;
      color: black;
    }
    footer {
      display: flex;
      justify-content: center;
      align-items: center;
      bottom: 0;
      width: 100%;
      min-height: 15vh;
      height: 15vh;
      background: #000;
      color: #fff;
      text-align: center;
      padding: 10px;
    }
  </style>
</head>
<body>

  <script>
    const isEditingIntro = false;

    async function loadProfile() {
        const userId = localStorage.getItem('userId');

        if(userId===null) {
            window.location.href = 'signin.html';
        }

        const response = await fetch('http://localhost:3000/api/user-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId })
        }).then(res => res.json())
        .then(data => {
          const statsContainer = document.getElementById('stats');
          const introContainer = document.getElementById('intro');
          statsContainer.innerHTML = `
            <div>
              <strong>${data.numTrips}</strong>
              <p>Trips</p>
            </div>
            <div>
              <strong>${data.numComments}</strong>
              <p>Comments</p>
            </div>
            <div>
              <strong>${data.numPhotos}</strong>
              <p>Photos</p>
            </div>
          `;

          if(data.user.intro === undefined || data.user.intro === null){
            introContainer.innerHTML = `
              <h3>Intro</h3>
              <p>Such empty 0-o.</p>
            `;
          }
          else{
            introContainer.innerHTML = `
              <h3>Intro</h3>
              <p>${data.user.intro}</p>
            `;
          }

          document.getElementById('profile-name').textContent = `${data.user.firstName} ${data.user.lastName}`;
          document.getElementById('profile-email').textContent = data.user.email;
          document.getElementById('profile-birth-date').innerHTML = `
            <span class="material-symbols-outlined">
              cake
              </span>
            <br>
            <span>${data.user.birthDate ? formatDate(data.user.birthDate) : 'Not provided'}</span>`;

          if(data.profileImageUrl){
            document.getElementById('profile-photo').style.backgroundImage = `url(${data.profileImageUrl})`;
          }

        }).catch(err => {
            console.error("Error while loading profile: ", err);
        });   
    }

    async function fetchTrips(){
      const userId = localStorage.getItem('userId');
      if(!userId){
        alert('You need to be signed in to view your past travels.');
        window.location.href = 'signin.html';
        return;
      }
      try {
        const response = await fetch('http://localhost:3000/api/fetch-trips', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId }),
        });
    
        const result = await response.json();
        if(response.ok && result.trips){
          const pastTrips = await result.trips.filter(trip => {
            return trip.state === "completed"
          });
          const upcomingTrips = await result.trips.filter(trip => {
            return trip.state === "planning"
          });
          const ongoingTrips = await result.trips.filter(trip => {
            return trip.state === "ongoing"
          });
          const pastTripsGrid = document.getElementById('past-travel-grid');
          const upcomingTripsGrid = document.getElementById('upcoming-travel-grid');
          const ongoingTripsGrid = document.getElementById('ongoing-travel-grid');
          const grids = [pastTripsGrid, upcomingTripsGrid, ongoingTripsGrid];
          const trips = [pastTrips, upcomingTrips, ongoingTrips];

          for(let i = 0; i < grids.length; i++){
            let grid = grids[i];
            let tripList = trips[i];
            grid.innerHTML = await tripList.map(trip => {
              return `
                <div class="travel-card">
                  ${trip.photoUrl ? `<img src=${trip.photoUrl} alt=${trip.destination}>` : ''}
                  <div class="travel-card-content">
                    <div class='row'>
                      <h3>${trip.destination}</h3>
                      <button class="trip-detail-btn" onclick="goToTripDetailPage('${trip._id}')">Details</button>
                    </div>
                    ${trip.budget ? `<p> <span class='trip-label'> Budget: </span> ${trip.budget}</p>` : ''}
                    ${trip.notes ? `<p> <span class='trip-label'> Note: </span> ${trip.notes}</p>` : ''}
                    <p> <span class='trip-label'> Trip Start Date: </span> ${formatDate(trip.startDate)}</p>
                    <p> With ${trip.numTravelers} travelers</p>
                    <div class="photo-section">
                      ${trip.images
                        ? (trip.images.length > 0 ? trip.images.slice(0, 7).map(image => {
                        return `<img src=${image.url} alt=${trip.destination}>`;
                        }).join('') : 'No photo uploaded yet.')
                      : 'No photo uploaded yet.'}
                    </div>
                    
                    
                    <div class="photo-comment-section">
                      <h5>Comments</h5>
                      ${trip.comments && trip.comments.length > 0 ? 
                        `<p> ${trip.comments[0].content} </p>` : 
                        'No comments yet.'}
                    </div>
                  </div>
                </div>
                  `;
            }).join('');
          }
        }
      } 
      catch (error) {
        console.error('Error fetching trips:', error);
        alert('An error occurred while fetching trips. Please try again later.');
      }
    }

    const formatDate = (date) => {
      const d = new Date(date);
      return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    }

    function goToTripDetailPage(tripId) {
      localStorage.setItem('tripId', tripId);
      window.location.href = 'tripDetail.html';
    }

    

    window.onload = () => {
      loadProfile();
      fetchTrips();
    }
  </script>
  
  <header class="header">
    <a href="main.html"><img src="Photo/Logo.jpg" alt="TerraVista Logo"></a>
    <a href="signOut.html" class="signout-link">Sign Out</a>
  </header>

  <main>
    <div class="profile-container">
      <div class="profile-photo" id="profile-photo"></div>
      <div class="profile-name" id="profile-name"></div>
      <div class="profile-email" id="profile-email"></div>
      <div class="profile-birth-date" id="profile-birth-date"></div>
      <a href="editProfile.html" class="edit-profile-btn">Edit Profile</a>
      <div class="stats" id="stats"></div>
    </div>
    
    <div class="intro" id="intro">
    </div>
    
    <div class="trips-container">
      <h2>Your Trips</h2>
      <div class="trip-actions">
        <a href="planTrip.html">Plan A New Trip</a>
      </div>
    
      <div class="trips-section">
        <h3>Ongoing Trips</h3>
        <p>View or extend your ongoing trips to better capture your experience.</p>
      <div class="travel-grid" id="ongoing-travel-grid"></div>
      </div>
    
      <div class="trips-section">
        <h3>Upcoming Trips</h3>
        <p>Manage your upcoming trips to ensure an amazing adventure.</p>
        <div class="travel-grid" id="upcoming-travel-grid"></div>
      </div>
    
      <div class="trips-section">
        <h3>Past Trips</h3>
        <p>Relive your adventures, uploading photos and keeping memories.</p>
        <div class="travel-grid" id="past-travel-grid"></div>
      </div>
    
    </div>
</main>


<footer>
  &copy; 2024 TerraVista | Every journey begins with a plan.
</footer>
</body>
</html>
  
</body>
</html>
